import React, { useState } from "react";

export default function TestarFiltroHT() {
  // data fixa conforme pedido (05 de dezembro de 2025)
  const [date, setDate] = useState("2025-12-05");
  const [matches, setMatches] = useState(null);
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [log, setLog] = useState("");
  const [last, setLast] = useState(5); // default safer

  async function handleFetchMatches() {
    setLoading(true);
    setLog(`Buscando jogos para ${date} (last=${last}) ...`);
    try {
      const res = await fetch(`/api/filtro?date=${date}&last=${last}`);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Erro ao buscar jogos: ${res.status} ${txt}`);
      }
      const data = await res.json();
      if (!Array.isArray(data)) {
        setLog("Resposta da API não é um array — verifique o endpoint");
        setMatches(null);
        setResults(null);
        setLoading(false);
        return;
      }
      setMatches(data);
      if (data.length === 0) {
        setLog("Nenhum jogo encontrado para essa data.");
        setResults([]);
      } else {
        setLog(`Encontrados ${data.length} partidas — mostrando ordenadas por score`);
        // já vem com _filter do backend, mas recalculamos por segurança
        const out = data.map((m) => m).sort((a, b) => (b._filter?.score ?? 0) - (a._filter?.score ?? 0));
        setResults(out);
      }
    } catch (e) {
      setLog(String(e));
      setMatches(null);
      setResults(null);
    } finally {
      setLoading(false);
    }
  }

  function downloadResults() {
    if (!results) return;
    const blob = new Blob([JSON.stringify(results, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `filtro_ht_results_${date}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div style={{ maxWidth: 900, margin: "18px auto", fontFamily: "Inter, Arial" }}>
      <h1>Testar — Filtro HT</h1>

      <div style={{ padding: 12, border: "1px solid #e6e6e6", borderRadius: 8, marginBottom: 12 }}>
        <label style={{ display: "block", marginBottom: 6 }}>Data</label>
        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
        <label style={{ marginLeft: 12 }}> Últimos (last)</label>
        <select value={last} onChange={(e) => setLast(Number(e.target.value))} style={{ marginLeft: 6 }}>
          <option value={3}>3</option>
          <option value={5}>5</option>
          <option value={8}>8</option>
          <option value={10}>10</option>
        </select>

        <div style={{ marginTop: 10 }}>
          <button onClick={handleFetchMatches} disabled={loading} style={{ marginRight: 8 }}>
            {loading ? "Buscando..." : "Buscar jogos"}
          </button>
          <button onClick={downloadResults} disabled={!results || results.length === 0}>
            Baixar JSON
          </button>
        </div>

        <div style={{ marginTop: 8, color: "#666" }}>Log: {log}</div>
      </div>

      <div>
        <h2>Resultados</h2>
        {!results && <div style={{ color: "#666" }}>Clique em "Buscar jogos" para começar.</div>}

        {results && results.length === 0 && <div>Nenhum jogo nesta data.</div>}

        {results && results.length > 0 && (
          <div>
            <div style={{ marginBottom: 8, fontSize: 14 }}>Total: {results.length}</div>
            <div>
              {results.map((m) => (
                <div key={m.id} style={{ border: "1px solid #eee", padding: 10, marginBottom: 8, borderRadius: 6 }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <div>
                      <div style={{ fontWeight: 700 }}>{m.home?.name ?? "Home"} × {m.away?.name ?? "Away"}</div>
                      <div style={{ color: "#666", fontSize: 12 }}>
                        pct(max): {Number(m._filter?.derived?.max_pct ?? 0).toFixed(3)} • shots total: {Number(m._filter?.derived?.total_shots ?? 0).toFixed(2)} • avg xG: {Number(m._filter?.derived?.avg_xg ?? 0).toFixed(2)}
                      </div>
                    </div>

                    <div style={{ textAlign: "right" }}>
                      <div style={{ fontWeight: 700, color: m._filter?.pass ? "#059669" : "#ef4444" }}>{m._filter?.pass ? "PASS" : "FAIL"}</div>
                      <div style={{ fontSize: 12 }}>Score: {Number(m._filter?.score ?? 0).toFixed(2)}</div>
                    </div>
                  </div>

                  <div style={{ marginTop: 8, fontSize: 13 }}>
                    <strong>Home</strong>: pctHT {Number(m.home?.ht_goal_pct ?? 0).toFixed(3)} • shotsHT {Number(m.home?.avg_shots_ht ?? 0).toFixed(2)} • xGht {Number(m.home?.xG_ht ?? 0).toFixed(2)}
                    <br />
                    <strong>Away</strong>: pctHT {Number(m.away?.ht_goal_pct ?? 0).toFixed(3)} • shotsHT {Number(m.away?.avg_shots_ht ?? 0).toFixed(2)} • xGht {Number(m.away?.xG_ht ?? 0).toFixed(2)}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
